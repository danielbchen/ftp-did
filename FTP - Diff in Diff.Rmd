---
title: "Florida's Family Transition Program - A Difference-in-Differences Analysis"
author: "Daniel Chen"
date: "3/26/2021"
output: html_document
---

```{r setup, include=FALSE}
library(foreign)
library(kableExtra) 
library(purrr)
library(tidyverse)
library(gridExtra)
library(broom)
library(car)
library(lmtest)
library(plm)
library(lfe)
library(estimatr)
library(stargazer)

setwd(paste("/Users/danielchen/Desktop",
            "/UChicago/Year Two/Autumn 2020/Program Evaluation/",
            "Problem Sets/Problem Set 4/", sep=""))

ftp <- read.dta("ftp_ar.dta")
ftp_srv <- read.dta("ftp_srv.dta")
```

#### The goal of this project is to analyze the effect of Florida's Family Transition Program on economic outcomes such as employment and welfare receipt. I will use a difference-in-differences approach. For this project, the treatment variable will not be the original assignment variable, but it will instead be whether or not an individual *believed* that their benefits were time limited.


To start, I need to find the quarterly employment for each of the 10 quarters prior to random assignment along with the 19 quarters that follow it. I do this to determine the longest pre-preiod and post-period sample to be analyzed, as I'll drop quarters containing any missing values. 

```{r Employment Means Setup, include=FALSE}
# Select all the pre_ra employment variables from the ftp_ar data only
employment_vars_pre_ra <- ftp %>%
  select(matches("emppq"))

# Calculate the means 
pre_ra_means <- colMeans(employment_vars_pre_ra, na.rm = TRUE)

# Create vector containing the quarter of random assignment 
exclude <- c("empq1")

# Select all the post_ra employment variables except for the quarter of assignment
employment_vars_post_ra <- ftp %>%
  select(starts_with("empq"), -one_of(exclude))

# Add back in the quarter of random assignment so we can check if there are any NA values 
employment_vars_post_ra_with_ra <- ftp %>%
  select(starts_with("empq"))

# Calculate means
post_ra_means <- colMeans(employment_vars_post_ra, na.rm = TRUE)

# Check columns for NA values in the pre_ra variables 
pre_ra_na_check <- colSums(is.na(employment_vars_pre_ra))

# Check columns for NA values in the post_ra variables
post_ra_na_check <- colSums(is.na(employment_vars_post_ra_with_ra))
```

```{r Employment Means Output, echo=FALSE}
# Print out pre-ra means in a table
t(pre_ra_means) %>% 
  kable(caption = "Means for Pre-RA Employment Variables",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

# Print out post-ra means in a table
post_ra_means %>% 
  kable(col.names = c("Mean"), 
        caption = "Means for Post-RA Employment Variables",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

# Print out table showing number of NA values in each pre-ra employment variable
t(pre_ra_na_check ) %>% 
  kable(caption = "Num. of NA Values in Pre-RA Employment Variables",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

# Print out table showing number of NA values in each post-ra employment variable
post_ra_na_check  %>% 
  kable(col.names = c("# of NAs"),
        caption = "Num. of NA Values in Post-RA Employment Variables",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

From the tables above the longest pre-period that I can analyze is 9 periods from `empqq1` to `emppq9` inclusive. The longest post-period that I can analyze is 17 periods from `empq1` to `empq17` inclusive as none of these contain NA values. `emppq10`, `empq18`, `empq19`, and `empq20` contain NA values.

Next I reshape our data from wide to long and calculate the mean employment rate by treatment status before and after treatment. I consider the period of random assignment itself to be in the after period. 

```{r Means by Treatment Status Before and After Treatment Setup, include=FALSE}
# Merge the two datasets 
merged_data <- ftp %>%
  inner_join(ftp_srv, by="sampleid") %>%
  rename_at(vars(ends_with(".x")), funs(str_replace(., "\\..$",""))) %>%
  select(-ends_with(".y"))

# Create the TLyes treatment indicator dummy
merged_data <- merged_data %>%
  filter(!is.na(fmi2)) %>%
  filter(fmi2 != 8) %>%
  mutate(TLyes = ifelse(fmi2 == 1, 1, 0))

# Create a vector containing the names of variables needed to reshape the data 
vars <- c("sampleid",
          "TLyes",
          names(employment_vars_pre_ra), 
          "empq1", # Add back in the quarter of RA
          names(employment_vars_post_ra)) # Remove cols with NA

# Calculate employment rates by treatment status before and after treatment.
employment_rate_matrix <- merged_data %>% 
  select(vars) %>% # Subset data to only include variables of interest 
  gather(Quarter, Employed, -sampleid, -TLyes) %>% # Reshapes data from wide to long
  mutate(post_treatment = case_when(Quarter %in% names(employment_vars_pre_ra) ~ 0, # Create post_treatment dummy indicator
                                    Quarter %in% names(employment_vars_post_ra) | Quarter == 'empq1' ~ 1)) %>% 
  group_by(TLyes, post_treatment) %>%
  summarize(Employment_Rate = mean(Employed, na.rm = TRUE)) # Calculate employment matrix

# Regress Employment Outcomes on the treatment variable only in the pre-treatment period
employment_rate_test <- merged_data %>% 
  select(vars) %>% # Subset data to only include variables of interest 
  gather(Quarter, Employed, -sampleid, -TLyes) %>% # Reshapes data from wide to long
  mutate(post_treatment = case_when(Quarter %in% names(employment_vars_pre_ra) ~ 0, # Create post_treatment dummy indicator
                                    Quarter %in% names(employment_vars_post_ra) | Quarter == 'empq1' ~ 1)) %>%
  filter(post_treatment == 0) %>%
  lm(Employed ~ TLyes, data =.)

# T-Test for difference in means 
ttest <- merged_data %>% 
  select(vars) %>% # Subset data to only include variables of interest 
  gather(Quarter, Employed, -sampleid, -TLyes) %>% # Reshapes data from wide to long
  mutate(post_treatment = case_when(Quarter %in% names(employment_vars_pre_ra) ~ 0, # Create post_treatment dummy indicator
                                    Quarter %in% names(employment_vars_post_ra) | Quarter == 'empq1' ~ 1)) %>%
  filter(post_treatment == 0) %>%
  t.test(Employed ~ TLyes, data = .)
```

```{r Employment Rate Matrix and t-Test Output, echo=FALSE}
employment_rate_matrix %>% 
  kable(caption = "Employment Rate by Treatment Group and Period",
        'html') %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

tidy(employment_rate_test) %>%
  kable(caption = "Employment Rate Explained by Treatment Status in pre-ra Period",
        'html') %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

tidy(ttest) %>%
  kable(caption = "Welch's Two Sample t-test Comparing Employment Rate in by Treatment Status in pre-ra Period",
        'html') %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```


In looking just at the employment rate table, the average employment for the control group prior to treatment (`TLyes` = 0 and `post_treat` = 0) was roughly 19% compared to the treatment group prior to treatment (`TLyes` = 1 and `post_treat` = 0) which was roughly 21%. They appear to be fairly close, but when I regress employment outcomes on `TLyes` restricting the sample only to the pre-treatment period, the p-value for the coefficient on `TLyes` is 0.0172577, suggesting a statistically significant difference between the employment rate in the pre-random assignment period between those who believe in the time limit and those who do not. I also ran Welch's Two Sample t-test explicitly and the test also confirms a meaningful difference in means with a p-value of .0161 and t-stat of -2.4072.

Next I run a difference-in-differences regression where the dependent variable is employment status, and the explanatory variables are the person dummies, quarter dummies, and an interaction between `TLyes` and a post-treatment dummy. I ignore the quarters containing NA values that I identified earlier. 

```{r OLS DiD Setup, include=FALSE}
# Store the names of the variables containing NA values into its own object 
na_cols <- c("emppq10", "empq18", "empq19", "empq20")

# Store the long dataframe into its own object and filter out the variables that contain NA values 
merged_data_long <- merged_data %>% 
  select(vars) %>% # Subset data to only include variables of interest 
  gather(Quarter, Employed, -sampleid, -TLyes) %>% # Reshapes data from wide to long
  mutate(post_treatment = case_when(Quarter %in% names(employment_vars_pre_ra) ~ 0, # Create post_treatment dummy indicator
                                    Quarter %in% names(employment_vars_post_ra) | Quarter == 'empq1' ~ 1)) %>%
  filter(!Quarter %in% na_cols)

# Run regression
ols <- lm(Employed ~ as.factor(sampleid) + as.factor(Quarter) + TLyes*post_treatment, data =  merged_data_long)
#model <- plm(Employed ~ sampleid + Quarter + TLyes*post_treatment, data = merged_data_long, index = c("sampleid", "Quarter"), model = "within")
#summary(model)

# Filter to only show the interaction term 
ols_output <- tidy(ols) %>%
  filter(term == "TLyes:post_treatment")
```

```{r Question 3a OLS DiD Output, echo=FALSE}
ols_output %>% 
  kable(caption = "Diff-in-Diff OLS Model",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

I run the same regression this time clustering the standard errores by `sampleid` because autocorrelation tends to be a problem for panel studies. While R provides multiple libraries to work with panel models, for this project I use the `plm` library. 

```{r Clustered OLS DiD Setup, include=FALSE, message=FALSE}
# Create the interaction term as its own variable 
merged_data_long$TLyes_post_treatment <- merged_data_long$TLyes * merged_data_long$post_treatment

# Run model using plm function and coeftest to get correct standard errors
clustered_plm <- plm(Employed ~ sampleid + Quarter + TLyes*post_treatment, 
                     data = merged_data_long, 
                     index = c("sampleid", "Quarter"), 
                     model = "within")
clustered_plm_output <- coeftest(clustered_plm, vcovHC(clustered_plm, type = "HC1", cluster = "group"))

clustered_plm_df <- tidy(clustered_plm_output) %>% 
  filter(term == "TLyes:post_treatment")
```

```{r Clustered OLS DiD Output, echo=FALSE}
# Print clustered output as a table
clustered_plm_df %>% 
  kable(caption = "Diff-in-Diff Clustered by sampleid Using plm()",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

The standard error of the interaction term increases from 0.01064142 (OLS without clustering) to roughly 0.01999 (clustered by `sampleid`). The standard error increases because clustering addresses time dependence. Observations at different times might not be independent. Because standard OLS doesn't account for this, we will overstate/overestimate the signficance of our results by (falsely) assuming greater precision in our estimates. 

In terms of interpretation, the interaction between `TLyes` and `post_treat` is our coefficient that tells us the average effect of treatment on the treated assuming all of our assumptions hold. In the context of this natural experiment, if an individual believes that their benefits are time-limited and they are in the post-period, this is - on average - associated with a roughly 5% increase in rate of being employed. The p-value is less than .05 suggesting a statistically meaningful difference.

Next, I construct a test for pre-treatment parallel trends. 

```{r Parallel Pre-Treatment Trends Test Setup, include=FALSE, warning=FALSE}
# Run regression using plm function
period_specific_effects <- plm(Employed ~ TLyes*Quarter + as.factor(sampleid) + as.factor(Quarter), 
                               data = merged_data_long, 
                               index = c("sampleid", "Quarter"), 
                               model = "within", 
                               effect = "twoways")

# Cluster the standard errors by sampleid
clustered_period_specific_effects <- coeftest(period_specific_effects, 
                                              vcovHC(period_specific_effects, 
                                                     type = "HC1", 
                                                     cluster = "group"))

# Store results into a dataframe 
heterogenous_effects <- tidy(clustered_period_specific_effects, conf.int = TRUE)

# Filter out all the pre-treatment effects and then relabel them correclty, and plot using ggplot
pre_treat_effects <- c("TLyes:Quarteremppq2",
                       "TLyes:Quarteremppq3",
                       "TLyes:Quarteremppq4",
                       "TLyes:Quarteremppq5",
                       "TLyes:Quarteremppq6",
                       "TLyes:Quarteremppq7",
                       "TLyes:Quarteremppq8",
                       "TLyes:Quarteremppq9")

pre_treat_estimates <- heterogenous_effects %>%
  filter(term %in% pre_treat_effects)
```

```{r Parallel Pre-Treatment Trends Test Output, echo=FALSE, warning=FALSE}
# Print table showing coefficients in the pre-treatment period
pre_treat_estimates %>% 
  kable(caption = "Heterogenous Pre-Treatment Period Specific Effects with Standard Errors Clustered by 'sampleid' using `plm()`",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

I regressed employment status on the person dummy, the quarter dummy, and the interaction between being treated in each quarter individually via the `plm()` function. Afterwards, I use `coeftest` to correct for standard errors, clustering by sampleid. The table below reports each period specific effect for all quarters in the pre-treatment period. I have dropped `emppq1` from the analysis to serve as a base for comparison. This corresponds to quarter 9, or the period just before treatment takes place since `emppq10` (pre-ra quarter 10) has been dropped for containing `NA` values. 

Next I plot the results. Each dot represents the estimated coefficient of the interaction between `TLyes` and `Quarter` or the estimated effect of being in the treatment group for a specific quarter in the pre-treatment period. The whiskers that extend in both directions from the points represent their respective confidence intervals at the 95% level. The x-axis labels are labeled in such a way where "9" represents quarter 9 - which is the period just before the treatment begins. Moreover, "9" corresponds to the variable `emppq1` or pre-ra quarter 1, which has again been dropped because we need it to serve as our base period in order to avoid multicollinearity. This means that "8" on the x-axis corresponds to the variable `emppq2` or pre-ra quarter 2, "7" would correspond to the variable `emppq3` and so on. As we move to the right on the x-axis, we're moving closer towards the treatment period. 

```{r Question 4a Parallel Pre-Treatment Trends Plot, echo=FALSE, warning=FALSE}
# Store all of the pre-treatment variables into a vector
pre_treat_effects <- c("TLyes:Quarteremppq2",
                       "TLyes:Quarteremppq3",
                       "TLyes:Quarteremppq4",
                       "TLyes:Quarteremppq5",
                       "TLyes:Quarteremppq6",
                       "TLyes:Quarteremppq7",
                       "TLyes:Quarteremppq8",
                       "TLyes:Quarteremppq9")

# Plot the period specific beta estimates
heterogenous_effects %>%
  filter(term %in% pre_treat_effects) %>%
  mutate(period = ifelse(term == "TLyes:Quarteremppq9", 1,
                                  ifelse(term == "TLyes:Quarteremppq8", 2,
                                         ifelse(term == "TLyes:Quarteremppq7", 3,
                                                ifelse(term == "TLyes:Quarteremppq6", 4,
                                                       ifelse(term == "TLyes:Quarteremppq5", 5,
                                                              ifelse(term == "TLyes:Quarteremppq4", 6,
                                                                     ifelse(term == "TLyes:Quarteremppq3", 7,
                                                                            ifelse(term == "TLyes:Quarteremppq2", 8, "NA"))))))))) %>%
  mutate(period = as.numeric(period)) %>%
  arrange(period) %>%
  ggplot(aes(x = period, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme_bw() +
  scale_x_discrete(breaks = c(1:9), labels = c(1:9), limits = c(1:9)) +
  labs(
    x = "Pre-Treatment Quarter",
    y = "Estimated Coefficients",
    title = "Estimated Heterogenous Effects in Periods Prior to Random Assignment"
  ) 
```


Note that testing for pre-treatment parallel trends is neither necessary nor sufficient because it is an approximate test that doesn't actually identify the important piece of parallel trends. We really need to observe the untreated outcome in the treatment group in the post-period. Through pre-treatment parallel trends, we *hope* that in the absence of the intervention, the potential untreated outcomes would have trended in a parallel manner in the periods before and after the intervention took place. They key word here is hope, as there is no guarantee that untreated outcomes would be parallel absent the intervention in the post-period.  

Now that I've looked at the period specific pre-treatment trends, I'll do the same for the post-period effects that vary freely over the post-treatment period. 

```{r Post-Treatment Trends Plot, echo=FALSE, warning=FALSE}
# Create a vector to store all the names of the post treatment interactions
post_treat_effects <- c("TLyes:Quarterempq1",
                       "TLyes:Quarterempq2",
                       "TLyes:Quarterempq3",
                       "TLyes:Quarterempq4",
                       "TLyes:Quarterempq5",
                       "TLyes:Quarterempq6",
                       "TLyes:Quarterempq7",
                       "TLyes:Quarterempq8",
                       "TLyes:Quarterempq9",
                       "TLyes:Quarterempq10",
                       "TLyes:Quarterempq11",
                       "TLyes:Quarterempq12",
                       "TLyes:Quarterempq13",
                       "TLyes:Quarterempq14",
                       "TLyes:Quarterempq15",
                       "TLyes:Quarterempq16",
                       "TLyes:Quarterempq17")

# Print out a table showing post-treatment heterogenous effects
heterogenous_effects %>%
  filter(term %in% post_treat_effects) %>% 
  kable(caption = "Heterogenous Post-Treatment Period Specific Effects with Standard Errors Clustered by 'sampleid'",
        "html") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

# Create plot
heterogenous_effects %>%
  filter(term %in% post_treat_effects) %>%
  mutate(period = ifelse(term == "TLyes:Quarterempq17", 26,
                         ifelse(term == "TLyes:Quarterempq16", 25,
                         ifelse(term == "TLyes:Quarterempq15", 24,
                         ifelse(term == "TLyes:Quarterempq14", 23,
                         ifelse(term == "TLyes:Quarterempq13", 22,
                         ifelse(term == "TLyes:Quarterempq12", 21,
                         ifelse(term == "TLyes:Quarterempq11", 20,
                         ifelse(term == "TLyes:Quarterempq10", 19,
                         ifelse(term == "TLyes:Quarterempq9", 18,
                         ifelse(term == "TLyes:Quarterempq8", 17,
                         ifelse(term == "TLyes:Quarterempq7", 16,
                         ifelse(term == "TLyes:Quarterempq6", 15,
                         ifelse(term == "TLyes:Quarterempq5", 14,
                         ifelse(term == "TLyes:Quarterempq4", 13,
                         ifelse(term == "TLyes:Quarterempq3", 12,
                         ifelse(term == "TLyes:Quarterempq2", 11,
                         ifelse(term == "TLyes:Quarterempq1", 10, "NA")))))))))))))))))) %>%
  mutate(period = as.numeric(period)) %>%
  arrange(period) %>%
  ggplot(aes(x = period, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme_bw() +
  scale_x_discrete(breaks = c(10:26), labels = c(10:26), limits = c(10:26)) +
  labs(
    x = "Post-Treatment Quarter",
    y = "Estimated Coefficients",
    title = "Estimated Heterogenous Effects in Periods After Random Assignment"
  ) 
```

With the exception of `empq9` ("18" on the x-axis) and `empq10` ("19" on the x-axis) none of the period specific estimates are statistically significant as all the confidence intervals encapsulate 0. However, this does not concern me. The DD estimator is concerned with the signficance of the average effect over the entire sample period. While there appears to be positive heterogenous effects in each post-period, the question is whether or not they are enough to make the average effect in the post-period significant by imposing the constraint that the period specific treatment.